<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jobmate.mapper.CommunityMapper">

    <!-- ============================================================
         ðŸ“Œ ì „ì²´ ë§¤í•‘ (alias ê¸°ë°˜ â†’ MyBatis ëŒ€ì†Œë¬¸ìž ë¬¸ì œ 100% í•´ê²°)
         ============================================================ -->
    <resultMap id="CommunityPostMap" type="com.jobmate.domain.CommunityPost">
        <id property="id" column="id"/>

        <result property="category" column="category"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="writer" column="writer"/>

        <result property="writerProfileBlob" column="writerProfileBlob" jdbcType="BLOB"/>
        <result property="postImageBlob" column="postImageBlob" jdbcType="BLOB"/>

        <result property="likeCount" column="likeCount"/>
        <result property="createdAt" column="createdAt"/>
    </resultMap>


    <!-- ============================================================
         ðŸ“Œ ì¹´í…Œê³ ë¦¬ë³„ ì¡°íšŒ - alias ê°•ì œ ì ìš©
         ============================================================ -->
    <select id="findByCategory" resultMap="CommunityPostMap">
        SELECT
            ID AS id,
            CATEGORY AS category,
            TITLE AS title,
            CONTENT AS content,
            WRITER AS writer,
            WRITER_PROFILE_BLOB AS writerProfileBlob,
            POST_IMAGE_BLOB AS postImageBlob,
            LIKE_COUNT AS likeCount,
            CREATED_AT AS createdAt
        FROM COMMUNITY_POST
        WHERE CATEGORY = #{category}
        ORDER BY ID DESC
    </select>


    <!-- ============================================================
         ðŸ“Œ IDë¡œ ë‹¨ì¼ ì¡°íšŒ
         ============================================================ -->
    <select id="findById" resultMap="CommunityPostMap">
        SELECT
            ID AS id,
            CATEGORY AS category,
            TITLE AS title,
            CONTENT AS content,
            WRITER AS writer,
            WRITER_PROFILE_BLOB AS writerProfileBlob,
            POST_IMAGE_BLOB AS postImageBlob,
            LIKE_COUNT AS likeCount,
            CREATED_AT AS createdAt
        FROM COMMUNITY_POST
        WHERE ID = #{id}
    </select>


    <!-- ============================================================
         ðŸ“Œ ê¸€ ìž‘ì„±
         ============================================================ -->
    <insert id="insertPost">
        INSERT INTO COMMUNITY_POST
        (ID, CATEGORY, TITLE, CONTENT, WRITER,
         WRITER_PROFILE_BLOB, POST_IMAGE_BLOB, LIKE_COUNT)
        VALUES
        (COMMUNITY_POST_SEQ.NEXTVAL,
         #{category}, #{title}, #{content}, #{writer},
         #{writerProfileBlob, jdbcType=BLOB},
         #{postImageBlob, jdbcType=BLOB},
         0)
    </insert>


    <!-- ============================================================
         ðŸ“Œ ê¸€ ì‚­ì œ
         ============================================================ -->
    <delete id="deletePost">
        DELETE FROM COMMUNITY_POST
        WHERE ID = #{id}
    </delete>


    <!-- ============================================================
         ðŸ“Œ ì¢‹ì•„ìš” ì—¬ë¶€ ì²´í¬
         ============================================================ -->
    <select id="isLiked" resultType="int">
        SELECT COUNT(*)
        FROM POST_LIKE
        WHERE POST_ID = #{postId}
        AND USER_ID = #{userId}
    </select>


    <!-- ì¢‹ì•„ìš” ì¶”ê°€ -->
    <insert id="insertLike">
        INSERT INTO POST_LIKE (POST_ID, USER_ID)
        VALUES (#{postId}, #{userId})
    </insert>

    <!-- ì¢‹ì•„ìš” ì·¨ì†Œ -->
    <delete id="deleteLike">
        DELETE FROM POST_LIKE
        WHERE POST_ID = #{postId}
        AND USER_ID = #{userId}
    </delete>


    <!-- ì¢‹ì•„ìš” ì¦ê°€ -->
    <update id="increaseLike">
        UPDATE COMMUNITY_POST
        SET LIKE_COUNT = LIKE_COUNT + 1
        WHERE ID = #{postId}
    </update>

    <!-- ì¢‹ì•„ìš” ê°ì†Œ -->
    <update id="decreaseLike">
        UPDATE COMMUNITY_POST
        SET LIKE_COUNT = LIKE_COUNT - 1
        WHERE ID = #{postId}
    </update>


    <!-- ìµœì‹  ì¢‹ì•„ìš” ìˆ˜ ì¡°íšŒ -->
    <select id="getLikeCount" resultType="int">
        SELECT LIKE_COUNT
        FROM COMMUNITY_POST
        WHERE ID = #{postId}
    </select>


    <!-- ============================================================
         ðŸ“Œ ê¸€ ìˆ˜ì • (ì´ë¯¸ì§€ í¬í•¨)
         ============================================================ -->
    <update id="updatePost">
        UPDATE COMMUNITY_POST
        SET
            TITLE = #{title},
            CONTENT = #{content},
            POST_IMAGE_BLOB = #{postImageBlob, jdbcType=BLOB}
        WHERE ID = #{id}
    </update>
    
    <delete id="deleteLikesByPost">
    	DELETE FROM POST_LIKE
    	WHERE POST_ID = #{postId}
	</delete>
	
	<!-- â¤ï¸ ë‚´ê°€ ì¢‹ì•„ìš”í•œ ê²Œì‹œê¸€ ì¡°íšŒ -->
	<select id="findLikedPostsByUser" resultMap="CommunityPostMap">
	    SELECT
	        p.ID AS id,
	        p.CATEGORY AS category,
	        p.TITLE AS title,
	        p.CONTENT AS content,
	        p.WRITER AS writer,
	        p.WRITER_PROFILE_BLOB AS writerProfileBlob,
	        p.POST_IMAGE_BLOB AS postImageBlob,
	        p.LIKE_COUNT AS likeCount,
	        p.CREATED_AT AS createdAt
	    FROM COMMUNITY_POST p
	    JOIN POST_LIKE l
	      ON p.ID = l.POST_ID
	    WHERE l.USER_ID = #{userId}
	    ORDER BY p.ID DESC
	</select>
	
    

</mapper>
